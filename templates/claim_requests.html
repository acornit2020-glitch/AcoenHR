<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Claim Requests</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="../static/img/Acorn.png" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="../static/css/style.css" rel="stylesheet">

</head>
<body>
<div class="container-fluid position-relative bg-white d-flex p-0">

    <!-- Sidebar Start -->
    <div class="sidebar pe-4 pb-3">
        <nav class="navbar bg-light navbar-light">
            <a href="/dashboard" class="navbar-brand mx-4 mb-3">
                <img src="../static/img/Acorn.png" alt="Acorn HR Logo" class="logo" style="height: 60px;">
            </a>

            <div class="d-flex align-items-center ms-4 mb-4">

                <div class="position-relative">
                    <img class="rounded-circle" src="../static/img/user.png" alt="" style="width: 40px; height: 40px;">
                    <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"></div>
                </div>

                <div class="ms-3">
                    <h6 class="mb-0">Admin</h6>
                    <span>{{ admin_name }}</span>
                </div>

            </div>

            <div class="navbar-nav w-100">
                <a href="/dashboard" class="nav-item nav-link"><i class="fa fa-tachometer-alt me-2"></i>Dashboard</a>
                <a href="/claim_requests" class="nav-item nav-link active"><i class="fa fa-eye me-2"></i>Claim Requests</a>
                <a href="/recent_requests" class="nav-item nav-link"><i class="fa fa-history me-2"></i>Recent Requests</a>
                <a href="/admin_form" class="nav-item nav-link"><i class="fa fa-user-plus me-2"></i>Create Employee</a>
                <a href="/emp_details" class="nav-item nav-link"><i class="fa fa-id-card me-2"></i>Edit Credits</a>
                <a href="/emp_update" class="nav-item nav-link"><i class="fa fa-user-edit me-2"></i>Update Employee</a>
                <a href="/generate_report" class="nav-item nav-link"><i class="fa fa-file-alt me-2"></i>Generate Reports</a>
            </div>

            <!-- Logout Button at the Bottom -->
            <div class="navbar-nav w-100 mt-auto">
                <div style="height: 61px;"></div>
                <hr class="my-2">
                <a href="/logout" class="nav-item nav-link" style="font-size: 14px;">
                    <i class="fa fa-sign-out-alt text-danger me-2" style="font-size: 12px;"></i> Log Out
                </a>

            </div>

        </nav>
    </div>
    <!-- Sidebar End -->


    <!-- Content Start -->
    <div class="content">

        <!-- Table Start -->
        <div class="container-fluid pt-4 px-4">

            <div class="row g-4">

                <div class="table-responsive">
                    <script>
                        const claimDetails = JSON.parse('{{ claim_details_dict | tojson | safe }}');
                    </script>
                    <table class="table text-start align-middle table-bordered table-hover mb-0" id="claimsTable">
                        <thead>
                            <tr class="text-dark">
                                <th scope="col">ClaimID</th>
                                <th scope="col">EmpID</th>
                                <th scope="col">Date Of Request</th>
                                <th scope="col">Amount (LKR)</th>
                                <th scope="col">Category</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in claims %}
                            <tr>
                                <td>{{ claim[0] }}</td> <!-- ClaimID -->
                                <td>{{ claim[1] }}</td> <!-- EmpID -->
                                <td>{{ claim[2].strftime('%d-%m-%Y') }}</td> <!-- Date Of Request -->
                                <td>{{ claim[3] }}</td> <!-- Category --> 
                                <td>{{ claim[4] }}</td> <!-- Amount --> 
                                <td>
                                    <form id="form" name="form" method="POST" action="{{ url_for('update_status') }}" enctype="multipart/form-data">
                                        <input type="hidden" name="claim_id" value="{{ claim[0] }}">
                                        <div>
                                            <select name="status" class="form-select" onchange="toggleCommentField(this, '{{ claim[0] }}')">
                                                <option value="Pending" {% if claim[4] == 'Pending' %}selected{% endif %}>Pending</option>
                                                <option value="Approved" {% if claim[4] == 'Approved' %}selected{% endif %}>Approved</option>
                                                <option value="Rejected" {% if claim[4] == 'Rejected' %}selected{% endif %}>Rejected </option>
                                            </select>
                                        </div>
                                        <div id="comment-section-{{ claim[0] }}" style="display: none; margin-top: 5px;">
                                            <textarea name="admin_message" placeholder="Enter comment" class="form-control"></textarea>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-primary mt-2" onclick="showMoreDetails('{{ claim[0] }}')">More Details</button>
                                        <button type="submit" class="btn btn-sm btn-primary mt-2">Submit</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>

        </div>
        <!-- Table End -->

    </div>
    <!-- Content End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
</div>

<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Template Javascript -->
<script src="../static/js/main.js"></script>
<script>

function toggleCommentField(select, claimId) 
{
    const commentSection = document.getElementById(`comment-section-${claimId}`);
    if (select.value === 'Approved' || select.value === 'Rejected') 
    {
        commentSection.style.display = 'block';
    } 
    else 
    {
        commentSection.style.display = 'none';
    }
}

function showMoreDetails(claimId) 
{
    const claim = claimDetails[claimId];
    const modal = new bootstrap.Modal(document.getElementById('moreDetailsModal'));
    const carouselInner = document.getElementById('carouselImages');
    const claimInfo = document.getElementById('claimInfo');

    // clear any existing images and claim info
    carouselInner.innerHTML = '';
    claimInfo.innerHTML = '';

    // check if claim details exist
    if (claim) 
    {
        // populate the claim details above the carousel
        claimInfo.innerHTML = `
            <table class="table table-bordered table-striped table-hover table-sm">
                <tbody>
                    <tr>
                        <td><strong>Claim ID</strong></td>
                        <td>${claim.ClaimID}</td>
                    </tr>
                    <tr>
                        <td><strong>Emp ID</strong></td>
                        <td>${claim.EmpID}</td>
                    </tr>
                    <tr>
                        <td><strong>Employee Name</strong></td>
                        <td>${claim.Employee.FirstName} ${claim.Employee.LastName}</td>
                    </tr>
                    <tr>
                        <td><strong>Email</strong></td>
                        <td>${claim.Employee.Email}</td>
                    </tr>
                    <tr>
                        <td><strong>SBU</strong></td>
                        <td>${claim.Employee.SBU}</td>
                    </tr>
                    <tr>
                        <td><strong>Telephone Number</strong></td>
                        <td>${claim.Employee.TpNo}</td>
                    </tr>
                    <tr>
                        <td><strong>Date of Request</strong></td>
                        <td>${claim.DateOfRequest}</td>
                    </tr>
                    <tr>
                        <td><strong>Category</strong></td>
                        <td>${claim.Category}</td>
                    </tr>
                    <tr>
                        <td><strong>Amount (LKR)</strong></td>
                        <td>${claim.Amount}</td>
                    </tr>
                    <tr>
                        <td><strong>Employee Message</strong></td>
                        <td>${claim.EmpMessage}</td>
                    </tr>
                </tbody>
            </table> `;

        // populate carousel with images (if any)
        const claimImages = claim.Images || [];
        if (claimImages.length > 0) 
        {
            claimImages.forEach((imgUrl, index) => 
            {
                const isActive = index === 0 ? 'active' : '';
                console.log(imgUrl);
                carouselInner.innerHTML += `
                    <div class="carousel-item ${isActive}">
                        <img src="/uploads/${imgUrl}" class="d-block w-100" alt="Invoice Image" style="border: 1px solid black;">
                    </div>
                `;
            });
        } 
        else 
        {
            carouselInner.innerHTML = `
                <div class="carousel-item active">
                    <p class="text-center">No images available for this claim.</p>
                </div>
            `;
        }

        // show the modal
        modal.show();
    } 
    else 
    {
        showPopup('Internal server error.');
    }
}


$('form').on('submit', function (e) 
{
    e.preventDefault(); // Prevent the default form submission

    var formData = new FormData(this); // Initialize formData

    // send the form data using fetch
    fetch('/update_status', 
    {
        method: 'POST',
        body: formData
    })
.then(response => response.json())
.then(data => 
{

    if (data.error) 
    {
        showPopup(data.error);
    } else 
    {
        actionSuccess(data.success);
        setTimeout(() => 
        {
            window.location.href = '/claim_requests';
        }, 3000);
    }
})
.catch(error => 
{
    console.error('Error:', error);
    showPopup("An unexpected error occurred!");
});

});

// popup messages for errors
function showPopup(message) 
{
    let popup = document.createElement("div");
    popup.classList.add("popup-message");
    popup.textContent = message;

    document.body.appendChild(popup);

    setTimeout(() => 
    {
        popup.remove();
    }, 5000);
}

// popup messages for success
function actionSuccess(message) 
{
        let popup = document.createElement("div");
        popup.classList.add("popup-message-success");
        popup.textContent = message;

        document.body.appendChild(popup);

        setTimeout(() => {
            
            popup.remove();
        }, 5000);
    }

</script>
<!-- Modal for More Details -->
<div class="modal fade" id="moreDetailsModal" tabindex="-1" aria-labelledby="moreDetailsLabel" aria-hidden="true">

    <div class="modal-dialog modal-lg">

        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title" id="moreDetailsLabel" style="text-align: center; width: 100%;">Claim Request Details</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <!-- Claim Details Section -->
                <div id="claimInfo"></div>

                <!-- Carousel for Claim Images -->
                <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">

                    <div class="carousel-inner" id="carouselImages"></div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>

            </div>

        </div>

    </div>

</div>

<style>

.carousel-control-prev-icon,
.carousel-control-next-icon 
{
    background-color: black !important; /* Change the button color to black */
}

.carousel-control-prev,
.carousel-control-next 
{
    color: black !important; /* Ensure the arrows are black as well */
}

.popup-message 
{
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #cd4132;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    z-index: 9999; /* Ensure it's on top */
    animation: fadein 0.3s;
}

@keyframes fadein 
{
    from { top: 0; opacity: 0; }
    to { top: 20px; opacity: 1; }
}

@keyframes fadeout 
{
    from { top: 20px; opacity: 1; }
    to { top: 0; opacity: 0; }
}

.popup-message-success 
{
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #078117;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 16px;
    font-weight: bold;
    z-index: 1000;
    animation: fadein 0.3s;
}

</style>
</body>
</html>